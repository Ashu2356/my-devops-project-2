pipeline {
  agent any

  environment {
    IMAGE_NAME = "ghcr.io/ashu2356/webapp:18"
  }

  stages {
    stage('Checkout') {
      steps {
        // Only one checkout
        git url: 'https://github.com/Ashu2356/my-devops-project-2.git'
      }
    }

    stage('Build WAR') {
      steps {
        dir('SprintBootService-1') {
          sh 'mvn clean install'
        }
      }
    }

    stage('Build & Push Docker Image to GHCR') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'ghcr-creds', usernameVariable: 'GITHUB_USERNAME', passwordVariable: 'GITHUB_TOKEN')]) {
          sh '''
            echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USERNAME --password-stdin
            docker build -t $IMAGE_NAME SprintBootService-1
            docker push $IMAGE_NAME
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        withCredentials([file(credentialsId: 'k8s-kubeconfig', variable: 'KUBECONFIG')]) {
          sh 'kubectl apply -f SprintBootService-1/k8s/deployment.yaml --kubeconfig=$KUBECONFIG'
        }
      }
    }
  }

  post {
    failure {
      echo "❌ Build or deployment failed."
    }
    success {
      echo "✅ Deployment successful!"
    }
  }
}
